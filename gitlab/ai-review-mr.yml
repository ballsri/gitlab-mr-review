.ai_review_mr:
  stage: review
  image: curlimages/curl:latest
  variables:
    AI_MODEL: "gemini"
    MODEL_NAME: "gemini-2.5-flash"
  rules:
    # Skip if in the template repo itself
    - if: $CI_PROJECT_PATH == "playground/ai-review-mr"
      when: never
    # Run on MR open event for all other repos
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_EVENT_TYPE == "merge_request"
      when: on_success
    # Fallback: never run otherwise
    - when: never
  script:
    - |
      echo "ü§ñ AI Review: MR !${CI_MERGE_REQUEST_IID} | Model: ${AI_MODEL}/${MODEL_NAME}"
      
      # Validate environment
      [ -z "$AI_REVIEWER_GITLAB_API_TOKEN" ] && echo "‚ùå Missing AI_REVIEWER_GITLAB_API_TOKEN" && exit 1
      [ -z "$AI_REVIEW_FUNCTION_API_URL" ] && echo "‚ùå Missing AI_REVIEW_FUNCTION_API_URL" && exit 1
      echo "‚úÖ Environment validated"
      
      # Call API
      echo "üöÄ Calling AI Review API..."
      START=$(date +%s)

      RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${AI_REVIEW_FUNCTION_API_URL}" \
        -H "Content-Type: application/json" \
        -d "{
          \"gitlab_token\": \"${AI_REVIEWER_GITLAB_API_TOKEN}\",
          \"project_id\": \"${CI_PROJECT_ID}\",
          \"merge_request_iid\": \"${CI_MERGE_REQUEST_IID}\",
          \"ai_model\": \"${AI_MODEL}\",
          \"model_name\": \"${MODEL_NAME}\"
        }")
      
      HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
      BODY=$(echo "$RESPONSE" | sed '$d')
      DURATION=$(($(date +%s) - START))
      
      echo "üì° Response: HTTP $HTTP_CODE (${DURATION}s)"
      
      # Parse response
      if [ "$HTTP_CODE" = "200" ]; then
        echo "‚úÖ Review completed"
        echo "$BODY"
        
        # Extract metrics
        FILES=$(echo "$BODY" | grep -o '"files_reviewed":[0-9]*' | cut -d':' -f2)
        ISSUES=$(echo "$BODY" | grep -o '"issues_found":[0-9]*' | cut -d':' -f2)
        TOKENS=$(echo "$BODY" | grep -o '"total":[0-9]*' | head -1 | cut -d':' -f2)
        COST=$(echo "$BODY" | grep -o '"total_cost_usd":[0-9.]*' | cut -d':' -f2)
        
        echo "üìä Files: $FILES | Issues: $ISSUES | Tokens: $TOKENS | Cost: \$$COST"
        echo "üëÄ View: ${CI_SERVER_URL}/${CI_PROJECT_PATH}/-/merge_requests/${CI_MERGE_REQUEST_IID}"
      else
        echo "‚ùå Failed: HTTP $HTTP_CODE"
        echo "$BODY"
        exit 1
      fi
  allow_failure: true
  timeout: 15m
  retry:
    max: 2
    when:
      - api_failure
      - runner_system_failure